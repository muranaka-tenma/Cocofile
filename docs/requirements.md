# CocoFile（ココファイル） - 要件定義書

要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

## 1. プロジェクト概要

### 1.1 成果目標
営業マンの「先週保存したあのファイル、どこだっけ？」を解決する、PC画面端常駐型スマートファイルアシスタント。タグ検索と自然な問いかけの両立により、エクスプローラーを開かずに瞬時にファイルアクセスできる個人利用特化型ツール。

### 1.2 成功指標

#### 定量的指標
1. **曖昧検索精度**: 「先週のABC社の見積もり」などの自然な問いかけで目的ファイルが上位3件以内に表示される確率90%以上
2. **検索速度**: 検索ワード入力から結果表示まで0.5秒以内
3. **タグ提案精度**: 自動タグ提案の受け入れ率が80%以上
4. **軽量性**: メモリ使用量が常時150MB以下、CPU使用率がアイドル時1%以下
5. **分析精度**: PDF/Excel/Word/PPT内のテキスト抽出成功率が95%以上
6. **小容量ファイル分析速度**: 5MB以下のファイルを2秒以内に分析完了

#### 定性的指標
1. **営業活動の邪魔をしない**: 画面端に収納、商談中でもサッと呼び出せる快適さ
2. **記憶に頼らない快適さ**: 「どこに保存したか覚えてない」でも自然な言葉で見つかる安心感
3. **エクスプローラー不要**: ファイル探しのストレスから完全に解放
4. **顧客対応の高速化**: 「ABC社の見積もり最新版」を3秒以内に取り出せる
5. **使うほど賢くなる**: 自分の仕事パターンを学習して精度が向上する実感

## 2. システム全体像

### 2.1 主要機能一覧
- **高速検索機能**: キーワード、タグ、日付範囲、ファイル種別による複合検索
- **自動ファイル分析**: PDF/Excel/Word/PowerPointの内容を自動抽出・インデックス化
- **スマートタグ提案**: ファイル名・内容から社名、ドキュメント種別を自動抽出して提案
- **リアルタイム監視**: 新規ファイル保存時に自動でインデックスに追加
- **重複ファイル検出**: 同一ファイルを複数の場所から検出
- **使用頻度学習**: よく使うファイルを上位に優先表示
- **プロジェクト自動グルーピング**: 同じ社名・プロジェクト名のファイルを自動でグループ化
- **ファイルプレビュー**: ファイルを開かずに内容をチラ見
- **常駐UI**: 画面端に配置、自動収納、ホットキー呼び出し

### 2.2 ユーザーロールと権限
- **単一ユーザー**: PCの所有者（個人利用）
- **全機能アクセス可能**: 認証・権限管理なし（OSレベルの保護に依存）

### 2.3 認証・認可要件
- **認証方式**: なし（OSレベルの認証に依存）
- **セキュリティレベル**: PC標準のファイル保護レベル
- **管理機能**: 不要（全てユーザー自身が操作）

## 3. 画面詳細仕様

### 3.1 S-001: メイン検索画面（常駐ウィンドウ）

#### 目的
ファイルの高速検索と即座のアクセス。営業活動中にエクスプローラーを開かずに必要なファイルを3秒以内に発見する。

#### 主要機能
- 検索ボックス（キーワード入力、自然文対応）
- フィルター（タグ、日付範囲、ファイル種別）
- 検索結果リスト（サムネイル・プレビュー付き）
- お気に入り表示エリア
- 最近使ったファイル表示エリア
- 画面端自動収納機能
- ホットキー呼び出し（デフォルト: Ctrl+Shift+F）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ファイル検索 | キーワード、フィルター条件 | マッチするファイルリスト（関連度順） |
| 取得 | お気に入りファイル表示 | なし | お気に入り登録済みファイルリスト |
| 取得 | 最近使用ファイル表示 | なし | 最近開いたファイルリスト（時系列順） |
| 作成 | ファイルを開く | ファイル選択 | 関連アプリケーションでファイルを開く |
| 作成 | フォルダを開く | ファイル選択 | エクスプローラーでファイルの場所を開く |

#### 処理フロー
1. ユーザーが検索ボックスにキーワードを入力
2. システムがSQLite FTS5で高速検索を実行
3. フィルター条件（タグ、日付、種別）を適用
4. 使用頻度スコアを加味してランキング
5. 検索結果をリスト表示（0.5秒以内）
6. ユーザーがファイルを選択してプレビューまたは開く

#### データ構造（概念）

```yaml
SearchQuery:
  識別子: 検索セッションID
  基本情報:
    - キーワード（任意）
    - タグフィルター（複数選択可）
    - 日付範囲（開始日、終了日）
    - ファイル種別フィルター（PDF/Excel/Word/PPT）
  メタ情報:
    - 検索実行日時
    - 検索結果件数
  関連:
    - SearchResult（1対多）

SearchResult:
  識別子: ファイルパス
  基本情報:
    - ファイル名（必須）
    - ファイルパス（必須）
    - ファイル種別（必須）
    - ファイルサイズ
    - サムネイル（あれば）
  メタ情報:
    - 関連度スコア
    - 使用頻度スコア
    - 最終アクセス日時
  関連:
    - FileMetadata（1対1）
```

---

### 3.2 S-002: 設定画面

#### 目的
アプリの動作設定とカスタマイズ。個人の作業環境に合わせた最適化。

#### 主要機能
- 監視フォルダの追加/削除
- ファイル分析タイミング設定（リアルタイム/アイドル時/手動）
- UI設定（ホットキー、自動収納の動作設定）
- タグ辞書管理（デフォルトタグの設定）
- 除外設定（特定フォルダ/ファイルタイプの除外）

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 現在の設定を表示 | なし | 全設定項目の現在値 |
| 作成 | 監視フォルダを追加 | フォルダパス | 監視リストに追加、スキャン開始 |
| 削除 | 監視フォルダを削除 | フォルダパス | 監視リストから削除、インデックス削除 |
| 更新 | 設定値を変更 | 設定項目、新しい値 | 設定の保存、即座に反映 |

#### データ構造（概念）

```yaml
AppSettings:
  識別子: 設定ファイルパス
  監視設定:
    - 監視フォルダリスト（複数）
    - 除外フォルダリスト（複数）
    - 除外ファイル拡張子リスト
    - 分析タイミング（realtime/idle/manual）
  UI設定:
    - ホットキー（デフォルト: Ctrl+Shift+F）
    - ウィンドウ位置（x, y座標）
    - 自動収納の有効/無効
    - テーマ（ライト/ダーク）
  タグ設定:
    - デフォルトタグリスト
    - タグカラー設定
  メタ情報:
    - 最終更新日時
```

---

### 3.3 S-003: スキャン・インデックス管理画面

#### 目的
ファイルのスキャン状況とデータベース管理。システムの健全性維持と重複ファイル削減。

#### 主要機能
- 手動スキャン実行
- スキャン進捗表示（リアルタイム）
- インデックス統計（総ファイル数、サイズ、最終更新日時）
- 重複ファイル一覧
- データベースのクリーンアップ/再構築

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | 手動スキャン開始 | 対象フォルダ（省略時は全監視フォルダ） | スキャン進捗、完了通知 |
| 取得 | インデックス統計表示 | なし | ファイル数、総サイズ、最終更新日時 |
| 取得 | 重複ファイル検出 | なし | 重複ファイルのグループリスト |
| 削除 | インデックスクリーンアップ | なし | 存在しないファイルをインデックスから削除 |
| 更新 | インデックス再構築 | なし | 全インデックスを削除して再スキャン |

#### 処理フロー
1. ユーザーが手動スキャンを開始
2. 監視フォルダを再帰的に走査
3. 各ファイルのメタデータ取得
4. ファイル内容の抽出（PDF/Excel/Word/PPT）
5. タグ自動提案の実行
6. SQLiteデータベースに保存
7. 進捗状況をリアルタイム表示（100ファイル/10秒目安）
8. 完了通知

#### データ構造（概念）

```yaml
ScanProgress:
  識別子: スキャンセッションID
  基本情報:
    - 対象フォルダパス
    - 処理済みファイル数
    - 総ファイル数
    - 進捗率（%）
    - 現在処理中のファイルパス
  メタ情報:
    - 開始日時
    - 経過時間
    - 推定残り時間

IndexStatistics:
  識別子: 統計情報ID
  基本情報:
    - 総ファイル数
    - 総ファイルサイズ（バイト）
    - DBサイズ（バイト）
    - ファイル種別ごとの内訳
  メタ情報:
    - 最終更新日時
    - 最終スキャン日時
```

---

### 3.4 S-004: タグ管理画面

#### 目的
タグの一括管理と整理。タグ体系の整理による検索精度向上。

#### 主要機能
- 全タグ一覧（使用頻度順）
- タグの統合（「ABC社」と「ABC株式会社」を統合）
- タグの一括編集
- 未使用タグの削除
- カラーラベル設定

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 全タグ一覧を表示 | ソート順（使用頻度/名前/作成日） | タグリスト |
| 更新 | タグを統合 | 統合元タグ、統合先タグ | タグの統合、関連ファイルの更新 |
| 更新 | タグ名変更 | 旧タグ名、新タグ名 | タグ名の変更、関連ファイルの更新 |
| 削除 | 未使用タグ削除 | なし | 使用されていないタグの一括削除 |
| 更新 | カラーラベル設定 | タグ名、カラーコード | タグにカラーを設定 |

#### データ構造（概念）

```yaml
Tag:
  識別子: タグ名（ユニーク）
  基本情報:
    - タグ名（必須）
    - カラーコード（任意）
    - 使用回数
    - 説明（任意）
  メタ情報:
    - 作成日時
    - 最終使用日時
  関連:
    - FileMetadata（多対多）
```

---

### 3.5 S-005: ファイル詳細・編集画面（モーダル/オーバーレイ）

#### 目的
個別ファイルの詳細情報とメタデータ編集。ファイルを開かずに内容確認とメタデータ追加。

#### 主要機能
- ファイルプレビュー（PDF/Excel/Word/PPT）
- メタデータ表示（作成日時、更新日時、サイズ等）
- タグ編集
- メモ追加
- ファイルを開く/フォルダを開く
- お気に入り登録/解除

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ファイル詳細を表示 | ファイルパス | 全メタデータ、プレビュー |
| 更新 | タグを追加/削除 | ファイルパス、タグ名 | タグリストの更新 |
| 更新 | メモを編集 | ファイルパス、メモ内容 | メモの保存 |
| 更新 | お気に入り登録/解除 | ファイルパス | お気に入り状態の変更 |
| 作成 | ファイルを開く | ファイルパス | 関連アプリでファイルを開く |

#### データ構造（概念）

```yaml
FileMetadata:
  識別子: ファイルパス（ユニーク）
  基本情報:
    - ファイル名（必須）
    - ファイルパス（必須）
    - ファイル種別（必須）
    - ファイルサイズ（バイト）
    - ハッシュ値（SHA256、重複検出用）
  抽出コンテンツ:
    - 抽出テキスト（全文）
    - 抽出キーワード（インデックス化）
  ユーザー追加情報:
    - タグリスト（複数）
    - メモ（任意）
    - お気に入りフラグ
    - カスタム名称（任意）
  メタ情報:
    - 作成日時（ファイルシステムから）
    - 更新日時（ファイルシステムから）
    - 最終アクセス日時（アプリ内）
    - アクセス回数
    - 初回インデックス登録日時
    - 最終インデックス更新日時
  関連:
    - Tag（多対多）
    - DuplicateGroup（1対多）
```

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
FileMetadata:
  概要: ファイルの全メタデータと抽出コンテンツ
  主要属性:
    - 基本情報: ファイル名、パス、種別、サイズ、ハッシュ値
    - 抽出コンテンツ: 全文テキスト、キーワード
    - ユーザー情報: タグ、メモ、お気に入り
    - 統計情報: アクセス回数、最終アクセス日時
  関連:
    - Tag（多対多）
    - DuplicateGroup（1対多）

Tag:
  概要: ファイル分類用のタグ
  主要属性:
    - タグ名、カラーコード、使用回数
  関連:
    - FileMetadata（多対多）

DuplicateGroup:
  概要: 重複ファイルのグループ
  主要属性:
    - グループID、ハッシュ値、ファイル数
  関連:
    - FileMetadata（1対多）

AppSettings:
  概要: アプリケーション設定
  主要属性:
    - 監視フォルダリスト、UI設定、タグ設定

ScanHistory:
  概要: スキャン履歴
  主要属性:
    - スキャン日時、対象フォルダ、処理ファイル数
```

### 4.2 エンティティ関係図

```
FileMetadata ─┬─ Tag              （多対多）
              ├─ DuplicateGroup   （多対1）
              └─ ScanHistory      （多対1）

AppSettings   ─── (独立)

SearchQuery   ─── SearchResult    （1対多）
```

### 4.3 バリデーションルール

```yaml
ファイルパス:
  - ルール: 実在するパス、絶対パスのみ
  - 理由: ファイルアクセスの確実性確保

タグ名:
  - ルール: 1-50文字、特殊文字制限（/ \ : * ? " < > |は禁止）
  - 理由: ファイルシステムとの互換性確保

ファイルサイズ:
  - ルール: 0バイト以上、500MB以下（分析対象）
  - 理由: パフォーマンス確保（500MB超は警告表示）

ハッシュ値:
  - ルール: SHA256形式（64文字16進数）
  - 理由: 重複検出の正確性確保
```

## 5. 制約事項

### 外部API制限
なし（完全ローカル動作）

### 技術的制約
- **ファイルサイズ制限**: 500MB超のファイルは分析に時間がかかる（警告表示）
- **同時スキャン数**: 1フォルダずつ順次処理（メモリ使用量制限のため）
- **データベース容量**: 10万ファイルで約100-150MB（SQLite制限内）
- **対応ファイル形式**: PDF、Excel（.xlsx/.xls）、Word（.docx）、PowerPoint（.pptx）のテキスト抽出のみ
- **画像内テキスト**: OCR非対応（Phase 1）

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 新規ファイル自動インデックス化
**トリガー**: ファイル監視システムが新規ファイル保存を検知
**フロントエンドAPI**: なし（バックグラウンド自動処理）
**バックエンド内部処理**:
1. ファイルメタデータ取得（サイズ、作成日時、更新日時）
2. ファイルハッシュ値計算（SHA256）
3. 重複ファイルチェック
4. ファイル内容抽出（PDF/Excel/Word/PPT）
5. キーワード抽出・インデックス化
6. タグ自動提案（ファイル名・内容から抽出）
7. SQLiteデータベースに保存
**結果**: インデックス登録完了（通知表示）
**外部サービス依存**: なし

### 複合処理-002: タグ統合
**トリガー**: ユーザーがタグ管理画面で「タグを統合」をクリック
**フロントエンドAPI**: POST /api/tags/merge
**バックエンド内部処理**:
1. 統合元タグに関連する全ファイルを取得
2. 統合先タグが存在するか確認、なければ作成
3. 全ファイルのタグを統合先タグに更新
4. 統合元タグを削除
5. タグ使用頻度を再集計
**結果**: タグ統合完了、関連ファイル数を表示
**外部サービス依存**: なし

### 複合処理-003: 重複ファイル検出
**トリガー**: ユーザーがスキャン・インデックス管理画面で「重複ファイル検出」をクリック
**フロントエンドAPI**: GET /api/files/duplicates
**バックエンド内部処理**:
1. 全ファイルのハッシュ値をグループ化
2. 同一ハッシュ値を持つファイルを抽出
3. ファイルパス、サイズ、更新日時を付加
4. グループごとにソート（更新日時順）
**結果**: 重複ファイルグループのリスト
**外部サービス依存**: なし

## 7. 技術スタック

```yaml
デスクトップアプリケーション:
  フレームワーク: Tauri 2.0
  理由: メモリ30-40MB、起動500ms以下、個人利用に最適

フロントエンド:
  言語: TypeScript
  UIフレームワーク: React 18
  UIライブラリ: shadcn/ui（シンプル・軽量）
  状態管理: Zustand（軽量）
  ビルドツール: Vite

バックエンド（ファイル分析エンジン）:
  言語: Python 3.10+
  通信: Tauri Command API

データベース:
  メインDB: SQLite 3.35+
  全文検索: FTS5 + N-gramトークナイザー（日本語対応）

ファイル解析ライブラリ:
  PDF: pdfplumber（MIT）
  Excel: openpyxl（MIT）
  Word: docx2txt（MIT）
  PowerPoint: python-pptx（MIT）

ファイル監視:
  ローカル: tauri-plugin-fs-watch
  クラウド/外部: ポーリング方式

インフラ:
  デプロイ: ローカルインストーラー（NSIS/MSI/DMG）
  データ保存: ローカルディスク（%APPDATA%/CocoFile）
```

## 8. 必要な外部サービス・アカウント

### 必須サービス
なし（完全ローカル動作）

### オプションサービス
なし

## 9. 今後の拡張予定

### Phase 2（スマート機能強化）
- 使用頻度ベースの優先表示の精度向上
- プロジェクト自動グルーピングの改善
- ファイルプレビューの対応形式拡大

### Phase 3（AI機能追加、オプション）
- Ollama統合による自然言語検索（「先週のABC社の見積もり」を自然文で検索）
- ChromaDB/LanceDB統合による意味検索（セマンティック検索）
- タグ提案の高精度化

### 商用版機能（ライセンス化検討）
- チーム共有機能（共通タグ辞書、ファイル共有）
- ネットワークドライブ対応
- 高度な分析機能（レポート生成、統計分析）
- OCR機能（画像内テキスト抽出）

---

**作成日**: 2025年11月4日
**対象ユーザー**: 営業マン（個人利用）
**開発目標**: MVP 3-4ヶ月でリリース、実際に使いながら改善
